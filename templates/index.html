<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Find My Recipe</title>

  <!-- Jinja link (keep) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css', v=3) }}">

  <!-- Hardcoded fallback (temporary test) -->
  <link rel="stylesheet" href="/static/style.css?v=3">
</head>
<body>
<header>
  <h1>FindMyRecipe</h1>
  <p>Type an ingredient and weâ€™ll find recipes that use it.</p>
</header>

<section class="search">
  <input id="ingredient" placeholder="e.g., tomato onion garlic" />
  <label class="checkbox"><input id="requireAll" type="checkbox" /> require all</label>
  <button id="go">Search</button>
</section>

<section id="results" class="results"></section>

<script>

    function isFavorited(id) {
        cookie = document.cookie
        regex = /-Fvrt:([\d,]*)-/g
        result = cookie.matchAll(regex)

        if (result.length < 2) {
            document.cookie = document.cookie + "-Fvrt:-"
            return false
        }
        else {
            fvrt_str = result.next().value[1]
            favorites = fvrt_str.split(",").map(num => parseInt(num))
            index = favorites.indexOf(id)
            return index != -1
        }
    }


    function getFavorites() {
        cookie = document.cookie
        regex = /-Fvrt:([\d,]*)-/g
        result = cookie.matchAll(regex)

        if (result.length < 2) {
            document.cookie = document.cookie + "-Fvrt:-"
            return []
        }
        else {
            fvrt_str = result.next().value[1]
            favorites = fvrt_str.split(",").map(num => parseInt(num))
            return favorites
        }
    }

    function setFavorites(arr) {
        fvrt_str = "-Fvrt:"
        for (var id of arr) {
            fvrt_str += id + ","
        }
        fvrt_str = fvrt_str.length > 6 ? fvrt_str.substring(0, fvrt_str.length - 1) : fvrt_str
        fvrt_str += "-"

        regex = /-Fvrt:([\d,]*)-/g
        cookie = document.cookie
        if (regex.test(cookie)) {
            document.cookie = document.cookie.replace(regex, fvrt_str)
        }
        else {
            document.cookie += fvrt_str
        }

   }

    function toggleFavorite(id) {

        favorites = getFavorites()
        index = favorites.indexOf(id)
        if (index != -1) {
            favorites.splice(index, 1)
            document.getElementById(`fvrt-${id}`).classList.remove("favorited")
        }
        else {
            favorites.push(id)
            document.getElementById(`fvrt-${id}`).classList.add("favorited")
        }
        setFavorites(favorites)
    }

async function search() {
  const q = document.getElementById('ingredient').value.trim();
  const requireAll = document.getElementById('requireAll').checked;
  if (!q) return;
  const url = `/search?ingredient=${encodeURIComponent(q)}&require_all=${requireAll}&k=12`;
  const res = await fetch(url);
  const data = await res.json();
  const box = document.getElementById('results');

  if (!data.length) {
    box.innerHTML = `<p class="empty">No recipes found.</p>`;
    return;
  }
  box.innerHTML = data.map(r => `
    <article class="card">
      ${r.image ? `<img src="${r.image}" alt="${r.title}" />` : ``}
      <div class="meta">
        <h3>${r.title}</h3>
        ${r["total time"] ? `<p class="time">${r["total time"]}</p>` : ``}
      </div>
      <p class="desc">${r.description ?? ""}</p>
      <p class="ing"><strong>Ingredients:</strong> ${r.ingredients}</p>
      <details><summary>Instructions</summary><p>${r.instructions}</p></details>
      <button id="fvrt-${r.ID}" title="Favorite" onclick="toggleFavorite(${r.ID})" class="favorite ${isFavorited(r.ID) ? "favorited" : ""}"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="m233-120 93-304L80-600h304l96-320 96 320h304L634-424l93 304-247-188-247 188Z"></path></svg></button>
    </article>
  `).join('');
}
document.getElementById('go').addEventListener('click', search);
document.getElementById('ingredient').addEventListener('keydown', e => { if (e.key === 'Enter') search(); });
</script>
</body>
</html>
