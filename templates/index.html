<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Find My Recipe</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css', v=7) }}">
</head>
<body>
<header>
  <h1>FindMyRecipe</h1>
  <p>Type an ingredient and we’ll find recipes that use it.</p>
</header>

<section class="search">
  <input id="ingredient" placeholder="e.g., tomato onion garlic" />
  <label class="checkbox"><input id="requireAll" type="checkbox" /> require all</label>
  <button id="go">Search</button>
  <button id="showFavs" class="secondary">⭐ Favorites</button>
</section>

<section id="results" class="results"></section>

<script>
const FAV_KEY = "findmyrecipe.favs";
function getFavs(){ try{ return new Set(JSON.parse(localStorage.getItem(FAV_KEY)||"[]")); }catch{ return new Set(); } }
function saveFavs(s){ localStorage.setItem(FAV_KEY, JSON.stringify([...s])); }
function isFav(id){ return getFavs().has(String(id)); }
function toggleFav(id){ const s=getFavs(), k=String(id); s.has(k)?s.delete(k):s.add(k); saveFavs(s); }

function recipeCard(r){
  const favActive = isFav(r.rid) ? "active" : "";
  return `
    <article class="card" data-rid="${r.rid}">
      ${r.image ? `<img src="${r.image}" alt="${r.title}" />` : ``}
      <div class="meta">
        <h3>${r.title}</h3>
        <div class="right-meta">
          ${r["total time"] ? `<span class="time">${r["total time"]}</span>` : ``}
          <button class="fav-btn ${favActive}" title="Toggle favorite" aria-label="Toggle favorite">★</button>
        </div>
      </div>
      <p class="desc">${r.description ?? ""}</p>
      <p class="ing"><strong>Ingredients:</strong> ${r.ingredients}</p>
      <details><summary>Instructions</summary><p>${r.instructions}</p></details>
    </article>
  `;
}

async function search()
{
  const q = document.getElementById('ingredient').value.trim();
  const requireAll = document.getElementById('requireAll').checked;
  if (!q) return;
  const url = `/search?ingredient=${encodeURIComponent(q)}&require_all=${requireAll}&k=12`;
  const res = await fetch(url);
  const data = await res.json();
  const box = document.getElementById('results');
  box.innerHTML = data.length ? data.map(recipeCard).join('') : `<p class="empty">No recipes found.</p>`;
}

document.getElementById('go').addEventListener('click', search);
document.getElementById('ingredient').addEventListener('keydown', e => { if (e.key === 'Enter') search(); });

document.getElementById('results').addEventListener('click', (e) => {
  const btn = e.target.closest('.fav-btn'); if (!btn) return;
  const card = e.target.closest('.card'); const rid = card?.getAttribute('data-rid'); if (!rid) return;
  toggleFav(rid); btn.classList.toggle('active', isFav(rid));
});

document.getElementById('showFavs').addEventListener('click', async () => {
  const favIds = [...getFavs()];
  const box = document.getElementById('results');
  if (!favIds.length){ box.innerHTML = `<p class="empty">No favorites yet. Add some ★</p>`; return; }
  const res = await fetch(`/recipes?ids=${encodeURIComponent(favIds.join(','))}`);
  const data = await res.json();
  box.innerHTML = data.length ? data.map(recipeCard).join('') : `<p class="empty">Couldn’t load your favorites.</p>`;
});
</script>
</body>
</html>
