<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FindMyRecipe</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css', v=27) }}">

  <link rel="icon" type="image/png"
        href="{{ url_for('static', filename='Image/FindMyRecipesBrandLogo_20250811203114.png') }}">
</head>
<body>

<header class="fm-header shadow-sm">
  <nav class="navbar navbar-expand-lg container-xxl">
    <a class="navbar-brand d-flex align-items-center gap-2" id="navHomeLogo" role="button">
      <img class="brand-logo" src="{{ url_for('static', filename='Image/FindMyRecipesBrandLogo_20250811203114.png') }}" alt="" />
      <span class="fw-bold">FindMyRecipe</span>
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
            aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
        <li class="nav-item"><button class="btn navlink active" id="navHome">Home</button></li>
        <li class="nav-item"><button class="btn navlink" id="navMyRecipes">My Recipes</button></li>
        <li class="nav-item"><button class="btn navlink" id="showFavs">‚≠ê Favorites</button></li>
        <li class="nav-item"><button class="btn navlink" id="toggleHistory">üïò History</button></li>
      </ul>
    </div>
  </nav>
</header>

<section class="hero">
  <div class="container-xxl">
    <h1 class="hero-title">Cook with what you have.</h1>
    <p class="hero-sub">Type ingredients you‚Äôve got ‚Äî we‚Äôll find recipes that fit.</p>

    <div class="hero-bar">
      <input id="ingredient" class="hero-input" placeholder="e.g. tomato, onion, garlic" aria-label="Ingredients to search" />
      <label class="hero-check" for="requireAll">
        <input id="requireAll" type="checkbox" aria-label="Require all ingredients" />
        require all
      </label>
      <button id="go" class="hero-btn" aria-label="Search recipes">Search</button>
    </div>

    <div class="quickchips" aria-label="Quick ingredient chips">
      <button type="button" class="chip" data-chip="chicken, rice, garlic">chicken + rice</button>
      <button type="button" class="chip" data-chip="pasta, tomato, basil">pasta + tomato</button>
      <button type="button" class="chip" data-chip="eggs, cheese, onion">eggs + cheese</button>
      <button type="button" class="chip" data-chip="potato, butter, garlic">potato</button>
    </div>
  </div>
</section>


<section id="history" class="history container-xxl" hidden>
  <div class="history-header">
    <h2>Recent searches</h2>
    <button id="clearHistory" class="linklike" type="button" title="Clear search history">Clear</button>
  </div>
  <ul id="historyList" class="history-list"></ul>
</section>


<section class="container-xxl">
  <div id="results" class="results" aria-live="polite" aria-atomic="true"></div>
</section>


<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
  <div id="appToast" class="toast align-items-center text-bg-dark border-0" role="status" aria-live="polite" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">Saved!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>


<button id="themeFab" class="theme-fab" aria-label="Toggle dark mode" title="Toggle dark mode">‚èæ</button>


<div class="modal fade recipe-modal" id="recipeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header align-items-start">
        <div class="w-100">
          <h5 class="modal-title mb-1" id="recipeModalTitle"></h5>
          <div class="d-flex gap-2 align-items-center flex-wrap">
            <span id="recipeModalTime" class="badge text-bg-light border"></span>
            <div class="ms-auto d-flex gap-2">
              <button id="modalSaveBtn" class="btn btn-sm btn-outline-primary">‚ûï My Recipes</button>
              <button id="modalFavBtn"  class="btn btn-sm btn-outline-warning">‚òÖ Favorite</button>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        
        <div class="modal-grid">
          <img id="recipeModalImg" class="modal-photo" alt="">
          <div class="modal-right">
            <h6 class="fw-bold mb-1">Description</h6>
            <p id="recipeModalDesc"></p>

            <h6 class="fw-bold mt-3">Ingredients</h6>
            <div id="recipeModalIngr"></div>
          </div>

          
          <div class="modal-instructions">
            <h6 class="fw-bold mb-2">Instructions</h6>
            <div id="recipeModalInstr"></div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>

const FAV_KEY = "findmyrecipe.favs";
function getFavs(){ try{ return new Set(JSON.parse(localStorage.getItem(FAV_KEY)||"[]")); }catch{ return new Set(); } }
function saveFavs(s){ localStorage.setItem(FAV_KEY, JSON.stringify([...s])); }
function isFav(id){ return getFavs().has(String(id)); }
function toggleFav(id){ const s=getFavs(), k=String(id); s.has(k)?s.delete(k):s.add(k); saveFavs(s); }

const MYREC_KEY = "findmyrecipe.myrecipes";
function getMyRecipes(){ try{ return new Set(JSON.parse(localStorage.getItem(MYREC_KEY)||"[]")); }catch{ return new Set(); } }
function saveMyRecipesSet(s){ localStorage.setItem(MYREC_KEY, JSON.stringify([...s])); }
function isMyRecipe(id){ return getMyRecipes().has(String(id)); }
function toggleMyRecipe(id){ const s=getMyRecipes(), k=String(id); s.has(k)?s.delete(k):s.add(k); saveMyRecipesSet(s); }

const recipeStore = new Map();
function escHTML(s=''){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

const HIST_KEY = "findmyrecipe.history";
const HIST_LIMIT = 20;
function getHistory(){ try { return JSON.parse(localStorage.getItem(HIST_KEY) || "[]"); } catch { return []; } }
function saveHistory(arr){ localStorage.setItem(HIST_KEY, JSON.stringify(arr)); }
function addToHistory(q, requireAll){
  if (!q) return;
  const item = { q, requireAll: !!requireAll, ts: Date.now() };
  let hist = getHistory().filter(h => !(h.q === q && !!h.requireAll === !!requireAll));
  hist.unshift(item);
  if (hist.length > HIST_LIMIT) hist = hist.slice(0, HIST_LIMIT);
  saveHistory(hist);
  renderHistory();
}
function formatAgo(ts){
  const diff = Math.max(0, Date.now() - ts);
  const mins = Math.floor(diff/60000), hrs = Math.floor(mins/60), days = Math.floor(hrs/24);
  if (mins < 1) return "just now";
  if (mins < 60) return `${mins}m ago`;
  if (hrs < 24) return `${hrs}h ago`;
  return `${days}d ago`;
}
function renderHistory(){
  const list = document.getElementById('historyList');
  const hist = getHistory();
  if (!hist.length){ list.innerHTML = `<li class="history-empty">No recent searches</li>`; return; }
  list.innerHTML = hist.map(h => {
    const safeQ = (h.q || "").replace(/"/g,'&quot;');
    const label = h.q.length > 60 ? h.q.slice(0,57) + '‚Ä¶' : h.q;
    return `
      <li>
        <button class="history-chip" data-q="${safeQ}" data-all="${h.requireAll ? '1':'0'}" title="Search again">
          ${label}
        </button>
        <span class="history-meta">${h.requireAll ? '‚Ä¢ all ' : ''}‚Ä¢ ${formatAgo(h.ts)}</span>
      </li>`;
  }).join('');
}
function clearHistory(){ localStorage.removeItem(HIST_KEY); renderHistory(); }
function toggleHistoryPanel(show){
  const el = document.getElementById('history');
  if (typeof show === 'boolean') el.hidden = !show; else el.hidden = !el.hidden;
}
function setActiveNavItem(id) {
  document.querySelectorAll('.navlink').forEach(btn => btn.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
}
function closeMenuAfterClick() {
  const c = document.querySelector('.navbar-collapse');
  if (c && c.classList.contains('show')) bootstrap.Collapse.getInstance(c).hide();
}

function showSkeleton(count=8){
  const s = Array.from({length: count}).map(() => `
    <article class="card wide skeleton">
      <div class="sk-img shimmer"></div>
      <div class="band">
        <div class="sk-line w-75 shimmer"></div>
        <div class="sk-line w-25 shimmer"></div>
      </div>
    </article>`).join('');
  document.getElementById('results').innerHTML = s;
}
function toast(msg="Saved"){
  const el = document.getElementById('appToast');
  document.getElementById('toastBody').textContent = msg;
  new bootstrap.Toast(el, {delay: 1400}).show();
}

function recipeCard(r){
  const favActive = isFav(r.rid) ? "active" : "";
  const myActive  = isMyRecipe(r.rid) ? "active" : "";
  const time = r["total time"] ? `${r["total time"]}` : "";
  const safeTitle = (r.title ?? "").replace(/"/g, '&quot;');

  recipeStore.set(String(r.rid), r);

  return `
    <article class="card wide" data-rid="${r.rid}">
      <figure class="thumb">
        ${r.image
          ? `<img src="${r.image}" alt="${safeTitle}" loading="lazy" />`
          : `<div class="img-fallback"></div>`}
      </figure>

      <div class="band">
        <div class="band-left">
          <h3 class="title" title="${safeTitle}">${r.title}</h3>
          ${time ? `<div class="time">${time}</div>` : ``}
        </div>
        <div class="band-right">
          <button class="icon-btn save-btn ${myActive}" title="Add/remove from My Recipes" aria-label="Toggle My Recipes">‚ûï</button>
          <button class="icon-btn fav-btn ${favActive}" title="Toggle favorite" aria-label="Toggle favorite">‚òÖ</button>
        </div>
      </div>

      <details class="more">
        <summary>Details</summary>
        ${r.description ? `<p class="desc">${r.description}</p>` : ``}
        <p class="ing"><strong>Ingredients:</strong> ${r.ingredients}</p>
        <p class="instr"><strong>Instructions:</strong> ${r.instructions}</p>
      </details>
    </article>`;
}

async function search(){
  const q = document.getElementById('ingredient').value.trim();
  const requireAll = document.getElementById('requireAll').checked;
  if (!q) return;
  showSkeleton();
  try{
    const url = `/search?ingredient=${encodeURIComponent(q)}&require_all=${requireAll}&k=12`;
    const res = await fetch(url);
    const data = await res.json();
    recipeStore.clear();
    const box = document.getElementById('results');
    box.innerHTML = data.length ? data.map(recipeCard).join('') : `<p class="empty">No recipes found.</p>`;
    addToHistory(q, requireAll);
  }catch(e){
    document.getElementById('results').innerHTML = `<p class="empty">Something went wrong. Please try again.</p>`;
  }
}

function upgradeImageUrl(url, target = 1600){
  try{
    const u = new URL(url, window.location.origin);
    if (u.searchParams.has('w'))     { u.searchParams.set('w', String(target)); return u.toString(); }
    if (u.searchParams.has('width')) { u.searchParams.set('width', String(target)); return u.toString(); }
    const cleaned = u.href.replace(/-\d+x\d+(?=\.(jpe?g|png|webp)(\?|$))/i, '');
    return cleaned;
  }catch{
    return url;
  }
}

function openRecipeModal(rid){
  const r = recipeStore.get(String(rid));
  if(!r) return;

  const img = document.getElementById('recipeModalImg');
  document.getElementById('recipeModalTitle').textContent = r.title || 'Recipe';
  document.getElementById('recipeModalTime').textContent  = r['total time'] || '';
  document.getElementById('recipeModalDesc').textContent  = r.description || '';

  const hi = r.image ? upgradeImageUrl(r.image, 1600) : '';
  img.src = hi;
  img.alt = r.title || '';
  img.loading = 'eager';
  img.decoding = 'async';

  const toList = (txt, ordered=false, extraClass='')=> {
    const t = (txt||'').trim();
    if(!t) return '<p class="text-muted">‚Äî</p>';
    
    const parts = t.split(/(?:\n+|‚Ä¢|\u2022|,)(?!\s*and\b)/).map(s=>s.trim()).filter(Boolean);
    if(parts.length<2) return `<p>${escHTML(t)}</p>`;
    const tag = ordered ? 'ol' : 'ul';
    const cls = extraClass ? ` class="${extraClass} mb-0"` : ' class="mb-0"';
    return `<${tag}${cls}>${parts.map(li=>`<li class="step">${escHTML(li)}</li>`).join('')}</${tag}>`;
  };

  document.getElementById('recipeModalIngr').innerHTML  = toList(r.ingredients, false);
  document.getElementById('recipeModalInstr').innerHTML = toList(r.instructions, false, 'step-bullets');

  // Wire modal action buttons
  const ridStr = String(r.rid);
  const favBtn  = document.getElementById('modalFavBtn');
  const saveBtn = document.getElementById('modalSaveBtn');
  const refresh = () => {
    favBtn.classList.toggle('btn-warning',         isFav(ridStr));
    favBtn.classList.toggle('btn-outline-warning', !isFav(ridStr));
    favBtn.textContent = isFav(ridStr) ? '‚òÖ Favorited' : '‚òÖ Favorite';

    saveBtn.classList.toggle('btn-primary',          isMyRecipe(ridStr));
    saveBtn.classList.toggle('btn-outline-primary',  !isMyRecipe(ridStr));
    saveBtn.textContent = isMyRecipe(ridStr) ? 'Saved ‚úì' : '‚ûï My Recipes';
  };
  refresh();

  favBtn.onclick  = ()=>{ toggleFav(ridStr);      refresh(); toast(isFav(ridStr) ? 'Added to Favorites' : 'Removed from Favorites'); };
  saveBtn.onclick = ()=>{ toggleMyRecipe(ridStr); refresh(); toast(isMyRecipe(ridStr) ? 'Saved to My Recipes' : 'Removed from My Recipes'); };

  const el = document.getElementById('recipeModal');
  const modal = (window.bootstrap && bootstrap.Modal && bootstrap.Modal.getOrCreateInstance)
                ? bootstrap.Modal.getOrCreateInstance(el, {backdrop:true})
                : null;
  if(modal) modal.show();
}

function updateThemeToggleIcon(theme){
  const btn = document.getElementById('themeFab');
  const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const isDark = theme === 'dark' || (!theme && systemDark);
  if (btn){
    btn.textContent = isDark ? '‚òÄÔ∏é' : '‚èæ';
    const label = isDark ? 'Switch to light mode' : 'Switch to dark mode';
    btn.setAttribute('aria-label', label);
    btn.title = label;
  }
}

document.getElementById('go').addEventListener('click', search);
document.getElementById('ingredient').addEventListener('keydown', e => { if (e.key === 'Enter') search(); });

document.querySelector('.quickchips').addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  document.getElementById('ingredient').value = chip.getAttribute('data-chip');
  search();
});

document.getElementById('results').addEventListener('click', (e) => {
  const card = e.target.closest('.card'); if (!card) return;
  const rid = card.getAttribute('data-rid'); if (!rid) return;

  if (e.target.closest('.fav-btn')) {
    toggleFav(rid);
    e.target.closest('.fav-btn').classList.toggle('active', isFav(rid));
    toast(isFav(rid) ? "Added to Favorites" : "Removed from Favorites");
    return;
  }
  if (e.target.closest('.save-btn')) {
    toggleMyRecipe(rid);
    e.target.closest('.save-btn').classList.toggle('active', isMyRecipe(rid));
    toast(isMyRecipe(rid) ? "Saved to My Recipes" : "Removed from My Recipes");
    return;
  }
  if (e.target.closest('summary')) return;

  openRecipeModal(rid);
});

document.getElementById('showFavs').addEventListener('click', async () => {
  setActiveNavItem('showFavs');
  const favIds = [...getFavs()];
  const box = document.getElementById('results');
  if (!favIds.length){ box.innerHTML = `<p class="empty">No favorites yet. Add some ‚òÖ</p>`; return; }
  showSkeleton(6);
  const res = await fetch(`/recipes?ids=${encodeURIComponent(favIds.join(','))}`);
  const data = await res.json();
  recipeStore.clear();
  box.innerHTML = data.length ? data.map(recipeCard).join('') : `<p class="empty">Couldn‚Äôt load your favorites.</p>`;
  closeMenuAfterClick();
});

async function showMyRecipes(){
  const ids = [...getMyRecipes()];
  const box = document.getElementById('results');
  if (!ids.length){
    box.innerHTML = `<p class="empty">No recipes saved yet. Add some ‚ûï</p>`;
    return;
  }
  showSkeleton(6);
  const res = await fetch(`/recipes?ids=${encodeURIComponent(ids.join(','))}`);
  const data = await res.json();
  recipeStore.clear();
  box.innerHTML = data.length ? data.map(recipeCard).join('')
                              : `<p class="empty">Couldn‚Äôt load your recipes.</p>`;
}
document.getElementById('navMyRecipes').addEventListener('click', function() {
  setActiveNavItem('navMyRecipes');
  showMyRecipes();
  closeMenuAfterClick();
});

document.getElementById('toggleHistory').addEventListener('click', () => {
  setActiveNavItem('toggleHistory');
  toggleHistoryPanel();
  if (!document.getElementById('history').hidden) renderHistory();
  closeMenuAfterClick();
});

document.addEventListener('click', (e) => {
  if (e.target.closest('#clearHistory')) { e.preventDefault(); clearHistory(); }
});

document.getElementById('historyList').addEventListener('click', (e) => {
  const btn = e.target.closest('.history-chip'); if (!btn) return;
  const q = btn.getAttribute('data-q') || '';
  const all = btn.getAttribute('data-all') === '1';
  document.getElementById('ingredient').value = q;
  document.getElementById('requireAll').checked = all;
  search();
});

document.getElementById('navHome').addEventListener('click', () => {
  setActiveNavItem('navHome');
  window.location.href = "{{ url_for('home') }}";
});
document.getElementById('navHomeLogo').addEventListener('click', () => {
  setActiveNavItem('navHome');
  window.location.href = "{{ url_for('home') }}";
});

const THEME_KEY = 'findmyrecipe.theme';
function applyTheme(theme){
  const root = document.documentElement;
  if (theme === 'light' || theme === 'dark') {
    root.setAttribute('data-theme', theme);
  } else {
    root.removeAttribute('data-theme'); 
  }
  updateThemeToggleIcon(theme);
}
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  applyTheme(saved ?? null);
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    if (!localStorage.getItem(THEME_KEY)) updateThemeToggleIcon(null);
  });
}
function wireThemeButtons(){
  const toggle = (e) => {
    e?.preventDefault?.();
    const current = document.documentElement.getAttribute('data-theme') || 'auto';
    const next = current === 'dark' ? 'light' : 'dark';
    localStorage.setItem(THEME_KEY, next);
    applyTheme(next);
  };
  document.getElementById('themeFab')?.addEventListener('click', toggle);
}

document.addEventListener('DOMContentLoaded', () => {
  if (getHistory().length) renderHistory();
  initTheme();
  wireThemeButtons();
});
</script>
</body>
</html>
